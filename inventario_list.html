<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Inventario · Sistema</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
  :root{ --card-bg: rgba(255,255,255,.12); --blur: blur(18px); --br:18px }
  *{font-family: Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial}
  body{
    min-height:100vh;margin:0;color:#fff;
    background:
      radial-gradient(1200px 600px at 10% 10%, #9db6d4 0%, transparent 60%),
      radial-gradient(900px 500px at 90% 20%, #9db6d4 0%, transparent 60%),
      linear-gradient(135deg,#7e8a8f,#74777d 60%,#9db6d4);
  }
  .glass{background:var(--card-bg);border:1px solid rgba(255,255,255,.15);backdrop-filter:var(--blur);
         border-radius:var(--br); box-shadow:0 10px 60px rgba(0,0,0,.25)}
  .brand{width:58px;height:58px;border-radius:14px;overflow:hidden;display:grid;place-items:center;
         background:linear-gradient(135deg,#8d98a5,#657274)}
  .muted{color:rgba(255,255,255,.85)}
  .nav-link{color:#e7ecff;margin-right:12px;text-decoration:none}
  .nav-link:hover,.nav-link.active{text-decoration:underline}
  .table-wrap{overflow:auto;border-radius:12px}
  table.table-dark{--bs-table-bg:rgba(0,0,0,.35);--bs-table-striped-bg:rgba(255,255,255,.05)}
  .btn-grad{background:linear-gradient(135deg,#2563eb,#1d4ed8);border:0;font-weight:700}
  .btn-icon{display:inline-flex;align-items:center;gap:.35rem}
  .form-control,.form-select{
    background:rgba(255,255,255,.18);color:#fff;border:1px solid rgba(255,255,255,.25)
  }
  .form-control::placeholder{color:#e8eeff}
  .form-control:focus,.form-select:focus{
    border-color:rgba(255,255,255,.6); box-shadow:0 0 0 .25rem rgba(99,102,241,.25);
    background:rgba(255,255,255,.22); color:#fff
  }

  /* ----- Estilos para los modales ----- */
  .modal .modal-content{
    background:rgba(20,25,34,.92);
    color:#fff;
    backdrop-filter: blur(12px);
    border:1px solid rgba(255,255,255,.15);
  }
  .modal .form-label{ color:#fff; }
  .modal .form-control,
  .modal .form-select{
    background:rgba(255,255,255,.15) !important;
    color:#fff !important;
    border:1px solid rgba(255,255,255,.35) !important;
  }
  .modal .form-control::placeholder{ color:rgba(255,255,255,.7) !important; }

  /* Combos normales fuera del modal */
  .form-select, 
  .form-select option { 
    color:#000 !important; 
    background-color:#fff; 
  }
</style>

</head>
<body>

<!-- Top bar -->
<div class="container pt-3">
  <div class="d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center gap-3">
      <div class="brand">
        <img src="{{ url_for('static', filename='ovalle.png') }}" alt="Logo" style="width:58px;height:58px;object-fit:cover">
      </div>
      <div>
        <div class="fw-bold">Sistema de Inventario</div>
        <small class="muted">Bienvenido, {{ session.get('user','') }} · Rol: {{ session.get('rol','') }}</small>
      </div>
    </div>

    <div class="d-none d-md-block">
      <a class="nav-link {% if request.path.startswith('/inicio') %}active{% endif %}" href="{{ url_for('inicio') }}">Inicio</a>
      <a class="nav-link active" href="{{ url_for('inventario_list') }}">Inventario</a>
      {% if session.get('rol') == 'Almacenista' %}
        <a class="nav-link {% if request.path.startswith('/salida') %}active{% endif %}" href="{{ url_for('salida') }}">Salida</a>
      {% endif %}
      {% if session.get('rol') == 'Administrador' %}
        <a class="nav-link {% if request.path.startswith('/historico') %}active{% endif %}" href="{{ url_for('historico') }}">Histórico</a>
      {% endif %}
    </div>

    <div>
      <a class="btn btn-outline-light btn-sm" href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-right me-1"></i>Salir</a>
    </div>
  </div>
</div>

<div class="container py-4">

  <!-- Flash -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for c,m in messages %}<div class="alert alert-{{c}} glass text-white">{{ m }}</div>{% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Header + Filtro + Agregar -->
  <div class="glass p-4 mb-3">
    <div class="d-flex flex-column flex-md-row align-items-md-end justify-content-between gap-3">
      <div>
        <h1 class="h4 m-0">Inventario</h1>
        <small class="muted">Altas, bajas, existencias y entradas</small>
      </div>

      <div class="d-flex align-items-end gap-3">
        <!-- Filtro de estatus con indicador -->
        <form method="get" action="{{ url_for('inventario_list') }}" class="d-flex align-items-center">
          <span class="badge bg-light text-dark me-2">Filtro:</span>
          <select class="form-select me-2" name="estatus" onchange="this.form.submit()">
            <option value="todos"   {% if request.args.get('estatus','todos') == 'todos' %}selected{% endif %}>Todos</option>
            <option value="activo"  {% if request.args.get('estatus') == 'activo' %}selected{% endif %}>Activos</option>
            <option value="inactivo"{% if request.args.get('estatus') == 'inactivo' %}selected{% endif %}>Inactivos</option>
          </select>
        </form>

        {% if session.get('rol') == 'Administrador' %}
          <button type="button" class="btn btn-grad btn-icon" data-bs-toggle="modal" data-bs-target="#modalAgregar">
            <i class="bi bi-plus-lg"></i>Agregar
          </button>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Tabla -->
  <div class="glass p-3">
    <div class="table-wrap">
      <table class="table table-dark table-striped align-middle mb-0">
        <thead>
          <tr>
            <th style="width:80px">ID</th>
            <th>Producto</th>
            <th style="width:140px">Precio</th>
            <th style="width:120px">Cantidad</th>
            <th style="width:120px">Estatus</th>
            <th style="width:320px" class="text-end">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% if productos and productos|length > 0 %}
            {% for p in productos %}
            <tr>
              <td>{{ p.idProducto }}</td>
              <td class="fw-semibold">{{ p.nombre }}</td>
              <td>$ {{ '%.2f'|format(p.precio) }}</td>
              <td>{{ p.cantidad }}</td>
              <td>
                {% if p.estatus %}
                  <span class="badge bg-success">Activo</span>
                {% else %}
                  <span class="badge bg-secondary">Inactivo</span>
                {% endif %}
              </td>
              <td class="text-end">
                {% if session.get('rol') == 'Administrador' %}
                  <!-- Entrada (abre modal) -->
                  <button type="button"
                          class="btn btn-sm btn-primary btn-icon"
                          data-bs-toggle="modal"
                          data-bs-target="#modalEntrada"
                          data-id="{{ p.idProducto }}"
                          data-nombre="{{ p.nombre }}">
                    <i class="bi bi-box-arrow-in-down"></i><span>Entrada</span>
                  </button>

                  <!-- Baja / Reactivar -->
                  {% if p.estatus %}
                    <form class="d-inline" method="post" action="{{ url_for('inventario_baja', id=p.idProducto) }}">
                      <button class="btn btn-sm btn-warning btn-icon" title="Dar de baja">
                        <i class="bi bi-eye-slash"></i><span>Baja</span>
                      </button>
                    </form>
                  {% else %}
                    <form class="d-inline" method="post" action="{{ url_for('inventario_reactivar', id=p.idProducto) }}">
                      <button class="btn btn-sm btn-success btn-icon" title="Reactivar">
                        <i class="bi bi-eye"></i><span>Reactivar</span>
                      </button>
                    </form>
                  {% endif %}

                  <!-- Eliminar -->
                  <form class="d-inline"
                        method="post"
                        action="{{ url_for('inventario_eliminar', id=p.idProducto) }}"
                        onsubmit="return confirm('Esto eliminará el producto solo si no tiene existencias ni historial. ¿Continuar?')">
                    <button class="btn btn-sm btn-danger btn-icon"
                            title="{% if p.idProducto in ids_con_historial %}No se puede eliminar: tiene historial{% else %}Eliminar{% endif %}"
                            {% if p.idProducto in ids_con_historial %}disabled aria-disabled="true"{% endif %}>
                      <i class="bi bi-trash"></i><span>Eliminar</span>
                    </button>
                  </form>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="6" class="text-center text-muted py-4">No hay productos.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>


<!-- Modal Entrada -->
<div class="modal fade" id="modalEntrada" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form id="formEntrada" method="post" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Entrada de inventario</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <label class="form-label">Producto</label>
          <input id="entradaProductoNombre" class="form-control" readonly>
        </div>
        <div>
          <label class="form-label">Cantidad a ingresar</label>
          <input name="cant" type="number" min="1" value="1" class="form-control" required>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary">Confirmar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Agregar -->
<div class="modal fade" id="modalAgregar" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form method="post" action="{{ url_for('inventario_agregar') }}" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Agregar producto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <label class="form-label">Nombre</label>
          <input class="form-control" name="nombre" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Precio</label>
          <input class="form-control" name="precio" inputmode="decimal" required>
        </div>
        <div>
          <label class="form-label">Estatus</label>
          <select class="form-select" name="estatus">
            <option value="1" selected>Activo</option>
            <option value="0">Inactivo</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-grad">Guardar</button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Llenar modal de Entrada dinámicamente
  const modalEntrada = document.getElementById('modalEntrada');
  modalEntrada.addEventListener('show.bs.modal', (event) => {
    const btn = event.relatedTarget;
    const id  = btn.getAttribute('data-id');
    const nom = btn.getAttribute('data-nombre');
    document.getElementById('entradaProductoNombre').value = nom;
    document.getElementById('formEntrada').action = `/inventario/${id}/entrada`;
  });
</script>
</body>
</html>
